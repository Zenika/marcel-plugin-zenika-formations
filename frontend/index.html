<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <script src="./marcel.js"></script>
</head>

<body>

  <ol id="content">

  </ol>

  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      width: 100vw;
      height: 100vh;
    }
  </style>

  <script>
    class ZenikaFormations extends Marcel.Plugin {
      constructor() {
        super({
          defaultProps: {
            agency: ''
          },
        })

        this.formationList = document.getElementById('content');
        this.urlFormationList = "http://localhost:8080/api/public/trainings"
        this.urlFormationDetail = "https://training.zenika.com/api/public/trainings/<ID>/planned-sessions"
      }

      getAllSessionsInAgency(agency) {
        fetch(this.urlFormationList)
          .then(response => response.json())
          .then(formJson => {
            Promise.all(formJson.map(e => getDetailFormation(e.id)))
          }).then(details => details.filter(e => e.agencyName === this.agency))
      }

      displayAllFuturSessions(agency) {
        getAllSessionsInAgency(agency)
          .then(sessions => {
            sessions.forEach(e => {
              const formation = document.createElement("li")
              formation.innerHTML = e.title + " | " + e.startDate
              this.formationList.appendChild(formation)
            })
          })
      }

      getDetailFormation(id) {
        const url = this.urlFormationDetail.replace("<ID>", id)
        return fetch(url).then(response => response.json())
      }

      propsDidChange(prevProps) {
        const { agency } = this.props
        if (agency !== prevProps.agency) {
          displayAllFuturSessions(agency)
        }
      }

      render() {
        const { agency } = this.props
        displayAllFuturSessions(agency)
      }
    }

    const instance = new ZenikaFormations()

    Marcel.Debug.changeProps({agence: "Nantes"})
  </script>
</body>

</html>